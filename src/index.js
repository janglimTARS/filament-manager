// This file is auto-generated by build.js
const HTML_CONTENT = "<!DOCTYPE html>\n<html lang=\"en\" class=\"dark\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n  <title>Filament Manager</title>\n  <script src=\"https://cdn.tailwindcss.com\"></script>\n  <script>\n    tailwind.config = {\n      theme: {\n        extend: {\n          colors: {\n            base: '#0f172a',\n            card: '#1e293b',\n            border: '#334155'\n          }\n        }\n      }\n    }\n  </script>\n  <link rel=\"stylesheet\" href=\"/styles.css\" />\n</head>\n<body class=\"bg-base text-slate-100 min-h-screen font-sans\">\n  <div class=\"max-w-6xl mx-auto p-4 sm:p-6 space-y-4\">\n    <header class=\"rounded-2xl border border-border bg-card p-4 sm:p-6\">\n      <div class=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n        <div>\n          <h1 class=\"text-2xl sm:text-3xl font-semibold\">Filament Inventory Manager</h1>\n          <p class=\"text-slate-400 mt-1\">Track filament spools, stock levels, and usage estimates.</p>\n        </div>\n        <button id=\"addSpoolBtn\" class=\"btn-primary\">+ Add Spool</button>\n      </div>\n    </header>\n\n    <section class=\"grid grid-cols-2 lg:grid-cols-4 gap-3\" id=\"statsGrid\"></section>\n\n    <section class=\"rounded-2xl border border-border bg-card p-4\">\n      <div class=\"grid grid-cols-1 md:grid-cols-4 gap-3\">\n        <input id=\"searchInput\" class=\"input md:col-span-2\" placeholder=\"Search brand, color, notes, location...\" />\n        <select id=\"materialFilter\" class=\"input\"></select>\n        <select id=\"brandFilter\" class=\"input\"></select>\n      </div>\n      <div class=\"flex flex-wrap gap-3 mt-3\">\n        <button id=\"exportBtn\" class=\"btn-secondary\">Export JSON</button>\n        <label class=\"btn-secondary cursor-pointer\">\n          Import JSON\n          <input type=\"file\" id=\"importInput\" accept=\"application/json\" class=\"hidden\" />\n        </label>\n      </div>\n    </section>\n\n    <section class=\"rounded-2xl border border-border bg-card p-4\">\n      <h2 class=\"text-lg font-semibold mb-3\">Inventory</h2>\n      <div id=\"spoolList\" class=\"space-y-3\"></div>\n      <div id=\"emptyState\" class=\"hidden text-center py-10 text-slate-400\">\n        <p class=\"text-lg\">No filament yet.</p>\n        <p>Add your first spool to get started.</p>\n      </div>\n    </section>\n\n    <section class=\"rounded-2xl border border-border bg-card p-4 space-y-3\">\n      <h2 class=\"text-lg font-semibold\">Printer (Bambu P1S)</h2>\n      <div class=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm\">\n        <div class=\"chip\">\n          <span>Status:</span>\n          <strong id=\"printerStatus\" class=\"flex items-center gap-2\">\n            <span id=\"printerStateDot\" class=\"inline-block w-2.5 h-2.5 rounded-full bg-slate-500\"></span>\n            <span id=\"printerStateText\">Offline</span>\n          </strong>\n        </div>\n        <div class=\"chip\"><span>Nozzle:</span><strong id=\"printerNozzle\">-- / -- °C</strong></div>\n        <div class=\"chip\"><span>Bed:</span><strong id=\"printerBed\">-- / -- °C</strong></div>\n        <div class=\"chip\"><span>Chamber:</span><strong id=\"printerChamber\">-- °C</strong></div>\n        <div class=\"chip\"><span>Layers:</span><strong id=\"printerLayers\">-- / --</strong></div>\n        <div class=\"chip\"><span>Fan Speed:</span><strong id=\"printerFan\">--</strong></div>\n      </div>\n      <div class=\"card space-y-2\">\n        <div class=\"flex items-center justify-between text-sm text-slate-300\">\n          <span id=\"printerFile\">No active job</span>\n          <span id=\"printerRemaining\">-- min left</span>\n        </div>\n        <div class=\"w-full bg-slate-800 rounded-full h-3\">\n          <div id=\"printerProgressBar\" class=\"h-3 rounded-full bg-cyan-400\" style=\"width:0%\"></div>\n        </div>\n        <div class=\"text-xs text-slate-400\"><span id=\"printerProgressText\">0%</span></div>\n      </div>\n      <div id=\"printerErrors\" class=\"hidden card border-red-500/40 text-sm text-red-300\"></div>\n      <div class=\"flex gap-2\">\n        <button id=\"configurePrinterBtn\" class=\"btn-secondary\">Configure Printer</button>\n        <button id=\"refreshPrinterBtn\" class=\"btn-secondary\">Refresh Status</button>\n      </div>\n    </section>\n\n    <section id=\"amsSection\" class=\"hidden rounded-2xl border border-border bg-card p-4 space-y-3\">\n      <div class=\"flex items-center justify-between\">\n        <h2 class=\"text-lg font-semibold\">AMS (Filament Slots)</h2>\n        <span id=\"amsHumidity\" class=\"text-sm text-slate-400\"></span>\n      </div>\n      <div id=\"amsSlots\" class=\"grid grid-cols-2 sm:grid-cols-4 gap-3\"></div>\n    </section>\n  </div>\n\n  <dialog id=\"spoolModal\" class=\"modal\">\n    <form id=\"spoolForm\" class=\"rounded-2xl border border-border bg-card p-4 sm:p-5 w-[92vw] max-w-2xl text-slate-100 space-y-3\">\n      <div class=\"flex items-center justify-between\">\n        <h3 id=\"modalTitle\" class=\"text-xl font-semibold\">Add Spool</h3>\n        <button type=\"button\" id=\"closeModalBtn\" class=\"text-slate-400 hover:text-white\">✕</button>\n      </div>\n      <input type=\"hidden\" id=\"spoolId\" />\n      <div class=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n        <input id=\"brand\" class=\"input\" placeholder=\"Brand\" required />\n        <input id=\"colorName\" class=\"input\" placeholder=\"Color name (e.g. Matte Black)\" required />\n        <input id=\"colorHex\" type=\"color\" class=\"input h-11 p-1\" value=\"#ffffff\" />\n        <select id=\"material\" class=\"input\" required>\n          <option>PLA</option><option>PETG</option><option>ABS</option><option>TPU</option><option>ASA</option><option>Other</option>\n        </select>\n        <input id=\"diameter\" class=\"input\" type=\"number\" step=\"0.01\" value=\"1.75\" required />\n        <select id=\"locationSelect\" class=\"input\"></select>\n        <input id=\"totalWeight\" class=\"input\" type=\"number\" min=\"1\" placeholder=\"Total weight (g)\" required />\n        <input id=\"remainingWeight\" class=\"input\" type=\"number\" min=\"0\" placeholder=\"Remaining (g)\" required />\n        <input id=\"purchaseDate\" class=\"input\" type=\"date\" />\n        <input id=\"cost\" class=\"input\" type=\"number\" step=\"0.01\" min=\"0\" placeholder=\"Cost ($)\" />\n      </div>\n      <textarea id=\"notes\" class=\"input min-h-24\" placeholder=\"Notes\"></textarea>\n      <button class=\"btn-primary w-full\" type=\"submit\">Save Spool</button>\n    </form>\n  </dialog>\n\n  <dialog id=\"printerModal\" class=\"modal\">\n    <form id=\"printerForm\" class=\"rounded-2xl border border-border bg-card p-4 w-[92vw] max-w-md space-y-3 text-slate-100\">\n      <h3 class=\"text-xl font-semibold\">Configure Printer</h3>\n      <input id=\"printerIp\" class=\"input\" placeholder=\"Printer IP (e.g. 192.168.1.50)\" required />\n      <input id=\"printerToken\" class=\"input\" placeholder=\"Access code (8-char from touchscreen)\" required />\n      <input id=\"printerSerial\" class=\"input\" placeholder=\"Serial number (e.g. 01P00A123456789)\" required />\n      <p class=\"text-xs text-slate-500\">Find serial in Bambu Handy app → Device → Device Info, or on the sticker on the back of the printer.</p>\n      <div id=\"printerSaveMsg\" class=\"hidden text-sm text-emerald-400 font-semibold\"></div>\n      <div class=\"flex gap-2\">\n        <button class=\"btn-primary flex-1\" type=\"submit\">Save</button>\n        <button class=\"btn-secondary flex-1\" type=\"button\" id=\"closePrinterModalBtn\">Cancel</button>\n      </div>\n    </form>\n  </dialog>\n\n  <dialog id=\"amsLinkModal\" class=\"modal\">\n    <div class=\"rounded-2xl border border-border bg-card p-4 w-[92vw] max-w-lg space-y-3 text-slate-100\">\n      <div class=\"flex items-center justify-between\">\n        <h3 id=\"amsLinkTitle\" class=\"text-lg font-semibold\">Link Spool</h3>\n        <button type=\"button\" id=\"closeAmsLinkModalBtn\" class=\"text-slate-400 hover:text-white\">✕</button>\n      </div>\n      <div id=\"amsLinkOptions\" class=\"space-y-2 max-h-[55vh] overflow-y-auto\"></div>\n    </div>\n  </dialog>\n\n  <script src=\"/app.js\"></script>\n</body>\n</html>\n";
const JS_CONTENT = "const MATERIAL_DENSITY = { PLA: 1.24, PETG: 1.27, ABS: 1.04, TPU: 1.21, ASA: 1.07, Other: 1.2 };\nconst ADD_LOCATION_VALUE = '__add_new_location__';\nconst PRINTER_STATUS_REFRESH_MS = 15000;\n\nlet spools = [];\nlet locations = [];\nlet currentEditId = null;\nlet amsMappingBySlot = {};\n\nconst els = {\n  statsGrid: document.getElementById('statsGrid'),\n  spoolList: document.getElementById('spoolList'),\n  emptyState: document.getElementById('emptyState'),\n  searchInput: document.getElementById('searchInput'),\n  materialFilter: document.getElementById('materialFilter'),\n  brandFilter: document.getElementById('brandFilter'),\n  spoolModal: document.getElementById('spoolModal'),\n  spoolForm: document.getElementById('spoolForm'),\n  modalTitle: document.getElementById('modalTitle'),\n  printerModal: document.getElementById('printerModal'),\n  locationSelect: document.getElementById('locationSelect'),\n  printerStateDot: document.getElementById('printerStateDot'),\n  printerStateText: document.getElementById('printerStateText'),\n  printerNozzle: document.getElementById('printerNozzle'),\n  printerBed: document.getElementById('printerBed'),\n  printerChamber: document.getElementById('printerChamber'),\n  printerFile: document.getElementById('printerFile'),\n  printerRemaining: document.getElementById('printerRemaining'),\n  printerLayers: document.getElementById('printerLayers'),\n  printerFan: document.getElementById('printerFan'),\n  printerProgressBar: document.getElementById('printerProgressBar'),\n  printerProgressText: document.getElementById('printerProgressText'),\n  printerErrors: document.getElementById('printerErrors'),\n  amsSection: document.getElementById('amsSection'),\n  amsHumidity: document.getElementById('amsHumidity'),\n  amsSlots: document.getElementById('amsSlots'),\n  amsLinkModal: document.getElementById('amsLinkModal'),\n  amsLinkTitle: document.getElementById('amsLinkTitle'),\n  amsLinkOptions: document.getElementById('amsLinkOptions'),\n};\n\ninit();\n\nasync function init() {\n  bindEvents();\n  await refreshAll();\n  await loadPrinterStatus();\n  setInterval(loadPrinterStatus, PRINTER_STATUS_REFRESH_MS);\n}\n\nfunction bindEvents() {\n  document.getElementById('addSpoolBtn').onclick = () => openSpoolModal();\n  document.getElementById('closeModalBtn').onclick = () => els.spoolModal.close();\n  document.getElementById('configurePrinterBtn').onclick = () => openPrinterModal();\n  document.getElementById('refreshPrinterBtn').onclick = () => loadPrinterStatus();\n  document.getElementById('closePrinterModalBtn').onclick = () => els.printerModal.close();\n  document.getElementById('closeAmsLinkModalBtn').onclick = () => els.amsLinkModal.close();\n  document.getElementById('exportBtn').onclick = exportJson;\n  document.getElementById('importInput').onchange = importJson;\n\n  els.searchInput.oninput = render;\n  els.materialFilter.onchange = render;\n  els.brandFilter.onchange = render;\n  els.locationSelect.onchange = onLocationSelect;\n\n  els.spoolForm.onsubmit = onSubmitSpool;\n  document.getElementById('printerForm').onsubmit = onSavePrinter;\n}\n\nasync function refreshAll() {\n  await Promise.all([loadSpools(), loadLocations(), loadPrinterConfig()]);\n  populateFilters();\n  refreshLocationSelect();\n  render();\n}\n\nasync function api(path, options = {}) {\n  const res = await fetch(path, {\n    headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },\n    ...options,\n  });\n\n  if (!res.ok) {\n    let msg = `Request failed (${res.status})`;\n    try {\n      const data = await res.json();\n      if (data?.error) msg = data.error;\n    } catch {}\n    throw new Error(msg);\n  }\n\n  if (res.status === 204) return null;\n  const ct = res.headers.get('content-type') || '';\n  return ct.includes('application/json') ? res.json() : null;\n}\n\nasync function loadSpools() {\n  spools = await api('/api/spools');\n}\n\nasync function loadLocations() {\n  locations = await api('/api/locations');\n}\n\nasync function loadAmsMapping() {\n  const rows = await api('/api/ams-mapping');\n  amsMappingBySlot = {};\n  for (const row of rows || []) {\n    const slot = Number(row.slot);\n    if (!Number.isFinite(slot)) continue;\n    amsMappingBySlot[slot] = String(row.spoolId || '');\n  }\n}\n\nfunction refreshLocationSelect(selected = '') {\n  const options = ['<option value=\"\">No location</option>'];\n  for (const loc of locations) {\n    options.push(`<option value=\"${escapeHtml(loc.name)}\">${escapeHtml(loc.name)}</option>`);\n  }\n  options.push(`<option value=\"${ADD_LOCATION_VALUE}\">➕ Add new location...</option>`);\n  els.locationSelect.innerHTML = options.join('');\n  els.locationSelect.value = selected || '';\n}\n\nasync function onLocationSelect() {\n  if (els.locationSelect.value !== ADD_LOCATION_VALUE) return;\n\n  const name = prompt('New storage location name:');\n  if (!name || !name.trim()) {\n    els.locationSelect.value = '';\n    return;\n  }\n\n  try {\n    await api('/api/locations', { method: 'POST', body: JSON.stringify({ name: name.trim() }) });\n    await loadLocations();\n    refreshLocationSelect(name.trim());\n  } catch (err) {\n    alert(err.message || 'Could not create location.');\n    els.locationSelect.value = '';\n  }\n}\n\nfunction openSpoolModal(spool = null) {\n  currentEditId = spool?.id || null;\n  els.modalTitle.textContent = spool ? 'Edit Spool' : 'Add Spool';\n  const set = (id, val = '') => (document.getElementById(id).value = val);\n\n  set('spoolId', spool?.id || '');\n  set('brand', spool?.brand || '');\n  set('colorName', spool?.colorName || '');\n  set('colorHex', spool?.colorHex || '#ffffff');\n  set('material', spool?.material || 'PLA');\n  set('diameter', spool?.diameter || 1.75);\n  set('totalWeight', spool?.totalWeight || '');\n  set('remainingWeight', spool?.remainingWeight || '');\n  set('purchaseDate', spool?.purchaseDate || '');\n  set('cost', spool?.cost || '');\n  set('notes', spool?.notes || '');\n  refreshLocationSelect(spool?.location || '');\n  els.spoolModal.showModal();\n}\n\nasync function onSubmitSpool(e) {\n  e.preventDefault();\n  const data = {\n    id: currentEditId || crypto.randomUUID(),\n    brand: v('brand'),\n    colorName: v('colorName'),\n    colorHex: v('colorHex'),\n    material: v('material'),\n    diameter: Number(v('diameter')) || 1.75,\n    totalWeight: Number(v('totalWeight')),\n    remainingWeight: Number(v('remainingWeight')),\n    location: els.locationSelect.value === ADD_LOCATION_VALUE ? '' : els.locationSelect.value,\n    purchaseDate: v('purchaseDate'),\n    cost: Number(v('cost')) || 0,\n    notes: v('notes'),\n  };\n\n  if (data.remainingWeight > data.totalWeight) {\n    alert('Remaining weight cannot be greater than total weight.');\n    return;\n  }\n\n  try {\n    if (currentEditId) {\n      await api(`/api/spools/${encodeURIComponent(currentEditId)}`, { method: 'PUT', body: JSON.stringify(data) });\n    } else {\n      await api('/api/spools', { method: 'POST', body: JSON.stringify(data) });\n    }\n\n    await loadSpools();\n    populateFilters();\n    els.spoolModal.close();\n    render();\n  } catch (err) {\n    alert(err.message || 'Failed to save spool.');\n  }\n}\n\nfunction v(id) {\n  return document.getElementById(id).value.trim();\n}\n\nasync function deleteSpool(id) {\n  if (!confirm('Delete this spool? This cannot be undone.')) return;\n  try {\n    await api(`/api/spools/${encodeURIComponent(id)}`, { method: 'DELETE' });\n    await loadSpools();\n    populateFilters();\n    render();\n  } catch (err) {\n    alert(err.message || 'Failed to delete spool.');\n  }\n}\n\nfunction getFiltered() {\n  const q = els.searchInput.value.toLowerCase();\n  const material = els.materialFilter.value;\n  const brand = els.brandFilter.value;\n\n  return spools.filter((s) => {\n    const matchesMaterial = material === 'All materials' || s.material === material;\n    const matchesBrand = brand === 'All brands' || s.brand === brand;\n    const searchable = Object.values(s).join(' ').toLowerCase();\n    const matchesSearch = !q || searchable.includes(q);\n    return matchesMaterial && matchesBrand && matchesSearch;\n  });\n}\n\nfunction render() {\n  const data = getFiltered();\n  renderStats();\n  els.spoolList.innerHTML = data.map(spoolCard).join('');\n  els.emptyState.classList.toggle('hidden', data.length !== 0);\n\n  data.forEach((s) => {\n    document.getElementById(`edit-${s.id}`)?.addEventListener('click', () => openSpoolModal(s));\n    document.getElementById(`delete-${s.id}`)?.addEventListener('click', () => deleteSpool(s.id));\n  });\n}\n\nfunction spoolCard(s) {\n  const pct = s.totalWeight ? (s.remainingWeight / s.totalWeight) * 100 : 0;\n  const low = pct < 20;\n  const lengthM = estimateLengthMeters(s.remainingWeight, s.material, s.diameter);\n\n  return `<div class=\"card ${low ? 'low-stock' : ''}\">\n    <div class=\"flex items-start justify-between gap-2\">\n      <div class=\"space-y-1\">\n        <div class=\"flex items-center gap-2\"><span class=\"swatch\" style=\"background:${s.colorHex}\"></span><h3 class=\"font-semibold\">${escapeHtml(s.brand)} — ${escapeHtml(s.colorName)}</h3></div>\n        <p class=\"text-sm text-slate-400\">${s.material} • ${s.diameter}mm • ${escapeHtml(s.location || 'No location')}</p>\n      </div>\n      <div class=\"text-right text-sm\">\n        <p class=\"${low ? 'text-amber-400 font-semibold' : 'text-slate-300'}\">${Math.round(s.remainingWeight)}g / ${Math.round(s.totalWeight)}g</p>\n        <p class=\"text-slate-500\">~${lengthM.toFixed(1)}m left</p>\n      </div>\n    </div>\n    <div class=\"mt-2 w-full bg-slate-800 rounded-full h-2\"><div class=\"h-2 rounded-full ${low ? 'bg-amber-400' : 'bg-cyan-400'}\" style=\"width:${Math.max(0, Math.min(100, pct))}%\"></div></div>\n    <div class=\"mt-2 text-sm text-slate-400 flex flex-wrap gap-4\">\n      <span>Purchased: ${s.purchaseDate || '—'}</span>\n      <span>Cost: $${(s.cost || 0).toFixed(2)}</span>\n      ${s.notes ? `<span>Notes: ${escapeHtml(s.notes)}</span>` : ''}\n    </div>\n    <div class=\"mt-3 flex gap-2\">\n      <button id=\"edit-${s.id}\" class=\"btn-secondary\">Edit</button>\n      <button id=\"delete-${s.id}\" class=\"btn-secondary\">Delete</button>\n    </div>\n  </div>`;\n}\n\nfunction estimateLengthMeters(weightG, material, diameterMm) {\n  const density = MATERIAL_DENSITY[material] || MATERIAL_DENSITY.Other;\n  const dCm = (diameterMm || 1.75) / 10;\n  const area = Math.PI * (dCm / 2) ** 2;\n  const volumeCm3 = weightG / density;\n  const lengthCm = volumeCm3 / area;\n  return lengthCm / 100;\n}\n\nfunction renderStats() {\n  const totalSpools = spools.length;\n  const totalWeight = spools.reduce((a, s) => a + (s.remainingWeight || 0), 0);\n  const totalValue = spools.reduce((a, s) => a + (s.cost || 0), 0);\n  const byMaterial = spools.reduce((acc, s) => {\n    acc[s.material] = (acc[s.material] || 0) + (s.remainingWeight || 0);\n    return acc;\n  }, {});\n\n  const materialSummary = Object.entries(byMaterial)\n    .map(([k, v]) => `${k}: ${Math.round(v)}g`)\n    .join(' • ') || 'No data';\n\n  els.statsGrid.innerHTML = `\n    <div class=\"card\"><p class=\"text-slate-400 text-sm\">Total Spools</p><p class=\"text-2xl font-semibold\">${totalSpools}</p></div>\n    <div class=\"card\"><p class=\"text-slate-400 text-sm\">Total Remaining</p><p class=\"text-2xl font-semibold\">${Math.round(totalWeight)}g</p></div>\n    <div class=\"card\"><p class=\"text-slate-400 text-sm\">Estimated Value</p><p class=\"text-2xl font-semibold\">$${totalValue.toFixed(2)}</p></div>\n    <div class=\"card\"><p class=\"text-slate-400 text-sm\">By Material</p><p class=\"text-sm\">${materialSummary}</p></div>\n  `;\n}\n\nfunction populateFilters() {\n  const materials = ['All materials', ...new Set(spools.map((s) => s.material))];\n  const brands = ['All brands', ...new Set(spools.map((s) => s.brand))];\n  fillSelect(els.materialFilter, materials);\n  fillSelect(els.brandFilter, brands);\n}\n\nfunction fillSelect(el, options) {\n  const current = el.value;\n  el.innerHTML = options.map((o) => `<option>${escapeHtml(o)}</option>`).join('');\n  if (options.includes(current)) el.value = current;\n}\n\nasync function exportJson() {\n  try {\n    const payload = await api('/api/export');\n    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });\n    const a = document.createElement('a');\n    a.href = URL.createObjectURL(blob);\n    a.download = 'filament-inventory.json';\n    a.click();\n    URL.revokeObjectURL(a.href);\n  } catch (err) {\n    alert(err.message || 'Failed to export.');\n  }\n}\n\nfunction importJson(e) {\n  const file = e.target.files[0];\n  if (!file) return;\n\n  const r = new FileReader();\n  r.onload = async () => {\n    try {\n      const parsed = JSON.parse(r.result);\n      await api('/api/import', { method: 'POST', body: JSON.stringify(parsed) });\n      await loadSpools();\n      populateFilters();\n      render();\n      alert('Import successful.');\n    } catch {\n      alert('Invalid JSON file or import failed.');\n    }\n  };\n  r.readAsText(file);\n  e.target.value = '';\n}\n\nasync function openPrinterModal() {\n  try {\n    const data = await api('/api/printer');\n    document.getElementById('printerIp').value = data.ip || '';\n    document.getElementById('printerToken').value = data.token || '';\n    document.getElementById('printerSerial').value = data.serial || '';\n    const msg = document.getElementById('printerSaveMsg');\n    msg.classList.add('hidden');\n    msg.textContent = '';\n    els.printerModal.showModal();\n  } catch (err) {\n    alert(err.message || 'Failed to load printer settings.');\n  }\n}\n\nasync function onSavePrinter(e) {\n  e.preventDefault();\n  const config = { ip: v('printerIp'), token: v('printerToken'), serial: v('printerSerial') };\n  const msg = document.getElementById('printerSaveMsg');\n  try {\n    await api('/api/printer', { method: 'PUT', body: JSON.stringify(config) });\n    msg.textContent = 'Saved! The printer bridge will pick this up shortly.';\n    msg.classList.remove('hidden');\n    await loadPrinterConfig();\n    setTimeout(() => { els.printerModal.close(); msg.classList.add('hidden'); }, 2000);\n  } catch (err) {\n    alert(err.message || 'Failed to save printer settings.');\n  }\n}\n\nasync function loadPrinterConfig() {\n  const data = await api('/api/printer');\n  if (!data.ip) {\n    setPrinterState('offline', 'Not configured');\n  }\n}\n\nasync function loadPrinterStatus() {\n  try {\n    const [status, mapping] = await Promise.all([\n      api('/api/printer-status'),\n      loadAmsMapping(),\n    ]);\n    renderPrinterStatus(status || {});\n    return mapping;\n  } catch {\n    setPrinterState('offline', 'Offline');\n    renderAms({});\n  }\n}\n\nfunction renderPrinterStatus(status) {\n  const state = String(status.state || 'offline').toLowerCase();\n  const progress = clamp(Number(status.progress || 0), 0, 100);\n  const errors = Array.isArray(status.errors) ? status.errors : [];\n\n  setPrinterState(state, prettyState(state));\n  els.printerNozzle.textContent = `${fmt(status.nozzleTemp)} / ${fmt(status.nozzleTarget)} °C`;\n  els.printerBed.textContent = `${fmt(status.bedTemp)} / ${fmt(status.bedTarget)} °C`;\n  els.printerChamber.textContent = `${fmt(status.chamberTemp)} °C`;\n  els.printerFile.textContent = status.currentFile || 'No active job';\n  els.printerRemaining.textContent = `${Math.max(0, Math.round(Number(status.remainingMinutes || 0)))} min left`;\n  els.printerLayers.textContent = `${Math.max(0, Math.round(Number(status.currentLayer || 0)))} / ${Math.max(0, Math.round(Number(status.totalLayers || 0)))}`;\n  els.printerFan.textContent = `${Math.max(0, Math.round(Number(status.fanSpeed || 0)))}`;\n  els.printerProgressBar.style.width = `${progress}%`;\n  els.printerProgressText.textContent = `${Math.round(progress)}%`;\n\n  if (errors.length) {\n    els.printerErrors.classList.remove('hidden');\n    els.printerErrors.innerHTML = `<strong class=\"block mb-1\">Errors</strong>${errors.map((e) => `<div>• ${escapeHtml(typeof e === 'string' ? e : JSON.stringify(e))}</div>`).join('')}`;\n  } else {\n    els.printerErrors.classList.add('hidden');\n    els.printerErrors.innerHTML = '';\n  }\n\n  renderAms(status.ams || {});\n}\n\nfunction renderAms(ams) {\n  const trays = Array.isArray(ams?.trays) ? ams.trays : [];\n  if (!trays.length) {\n    els.amsSection.classList.add('hidden');\n    els.amsHumidity.textContent = '';\n    els.amsSlots.innerHTML = '';\n    return;\n  }\n\n  const currentTray = Number(ams?.currentTray);\n  const humidity = Number(ams?.humidity);\n  els.amsSection.classList.remove('hidden');\n  els.amsHumidity.textContent = Number.isFinite(humidity) ? `Humidity: ${Math.max(0, Math.round(humidity))}%` : '';\n\n  els.amsSlots.innerHTML = trays.map((tray, idx) => {\n    const slot = Number.isFinite(Number(tray?.slot)) ? Number(tray.slot) : idx;\n    const material = String(tray?.material || 'Unknown').trim() || 'Unknown';\n    const colorHexRaw = String(tray?.color || '').trim();\n    const colorHex = normalizeHex(colorHexRaw);\n    const isActive = slot === currentTray;\n    const activeBadge = isActive ? '<span class=\"text-[10px] px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-300\">ACTIVE</span>' : '';\n    const borderStyle = isActive && colorHex ? `border-color:${colorHex}; box-shadow: inset 0 0 0 1px ${colorHex}55;` : '';\n\n    const linkedSpoolId = amsMappingBySlot[slot] || '';\n    const linkedSpool = linkedSpoolId ? spools.find((s) => s.id === linkedSpoolId) : null;\n    const linkedText = linkedSpool\n      ? `${escapeHtml(linkedSpool.brand)} — ${escapeHtml(linkedSpool.colorName)}`\n      : 'No linked spool';\n\n    return `<div class=\"rounded-xl border border-border bg-slate-900/40 p-3 space-y-2\" style=\"${borderStyle}\">\n      <div class=\"flex items-center justify-between\">\n        <div class=\"w-5 h-5 rounded-full border border-slate-500\" style=\"background:${colorHex || '#64748b'}\"></div>\n        ${activeBadge}\n      </div>\n      <div class=\"text-sm font-semibold\">${escapeHtml(material)}</div>\n      <div class=\"text-xs text-slate-400\">Slot ${slot + 1}</div>\n      <div class=\"text-xs text-slate-400\">${linkedText}</div>\n      <div>\n        ${linkedSpool\n          ? `<button data-unlink-slot=\"${slot}\" class=\"text-xs text-slate-400 hover:text-rose-300 underline-offset-2 hover:underline\">Unlink</button>`\n          : `<button data-link-slot=\"${slot}\" class=\"btn-secondary text-xs py-1 px-2\">Link Spool</button>`}\n      </div>\n    </div>`;\n  }).join('');\n\n  els.amsSlots.querySelectorAll('[data-link-slot]').forEach((btn) => {\n    btn.addEventListener('click', () => openAmsLinkModal(Number(btn.getAttribute('data-link-slot'))));\n  });\n\n  els.amsSlots.querySelectorAll('[data-unlink-slot]').forEach((btn) => {\n    btn.addEventListener('click', () => unlinkAmsSlot(Number(btn.getAttribute('data-unlink-slot'))));\n  });\n}\n\nfunction openAmsLinkModal(slot) {\n  els.amsLinkTitle.textContent = `Link Spool to AMS Slot ${slot + 1}`;\n\n  if (!spools.length) {\n    els.amsLinkOptions.innerHTML = '<div class=\"text-sm text-slate-400\">No spools in inventory yet.</div>';\n    els.amsLinkModal.showModal();\n    return;\n  }\n\n  els.amsLinkOptions.innerHTML = spools.map((s) => {\n    return `<button data-select-spool=\"${escapeHtml(s.id)}\" data-slot=\"${slot}\" class=\"w-full text-left rounded-lg border border-border bg-slate-900/50 hover:border-slate-500 px-3 py-2 text-sm\">\n      <div class=\"flex items-center gap-2\">\n        <span class=\"swatch\" style=\"background:${escapeHtml(s.colorHex || '#ffffff')}\"></span>\n        <span class=\"font-medium\">${escapeHtml(s.brand)} — ${escapeHtml(s.colorName)}</span>\n      </div>\n      <div class=\"text-xs text-slate-400 mt-1\">${escapeHtml(s.material)} • ${Math.round(Number(s.remainingWeight || 0))}g left</div>\n    </button>`;\n  }).join('');\n\n  els.amsLinkOptions.querySelectorAll('[data-select-spool]').forEach((btn) => {\n    btn.addEventListener('click', () => {\n      const spoolId = btn.getAttribute('data-select-spool');\n      const targetSlot = Number(btn.getAttribute('data-slot'));\n      linkAmsSlot(targetSlot, spoolId);\n    });\n  });\n\n  els.amsLinkModal.showModal();\n}\n\nasync function linkAmsSlot(slot, spoolId) {\n  try {\n    await api(`/api/ams-mapping/${slot}`, {\n      method: 'PUT',\n      body: JSON.stringify({ spoolId }),\n    });\n    els.amsLinkModal.close();\n    await loadPrinterStatus();\n  } catch (err) {\n    alert(err.message || 'Failed to link spool.');\n  }\n}\n\nasync function unlinkAmsSlot(slot) {\n  try {\n    await api(`/api/ams-mapping/${slot}`, { method: 'DELETE' });\n    await loadPrinterStatus();\n  } catch (err) {\n    alert(err.message || 'Failed to unlink spool.');\n  }\n}\n\nfunction setPrinterState(state, text) {\n  const colors = {\n    printing: 'bg-emerald-400',\n    idle: 'bg-amber-400',\n    paused: 'bg-amber-400',\n    error: 'bg-red-500',\n    offline: 'bg-slate-500',\n  };\n\n  els.printerStateDot.className = `inline-block w-2.5 h-2.5 rounded-full ${colors[state] || colors.offline}`;\n  els.printerStateText.textContent = text;\n}\n\nfunction prettyState(state) {\n  if (state === 'printing') return 'Printing';\n  if (state === 'idle') return 'Idle';\n  if (state === 'paused') return 'Paused';\n  if (state === 'error') return 'Error';\n  return 'Offline';\n}\n\nfunction fmt(value) {\n  const n = Number(value || 0);\n  return Number.isFinite(n) ? n.toFixed(1) : '0.0';\n}\n\nfunction clamp(n, min, max) {\n  return Math.max(min, Math.min(max, Number.isFinite(n) ? n : min));\n}\n\nfunction normalizeHex(value = '') {\n  const raw = String(value).trim().replace(/^#/, '');\n  if (!raw) return '';\n  const withoutAlpha = raw.length === 8 ? raw.slice(0, 6) : raw;\n  if (!/^[0-9a-fA-F]{6}$/.test(withoutAlpha)) return '';\n  return `#${withoutAlpha}`;\n}\n\nfunction escapeHtml(str = '') {\n  return str.replace(/[&<>'\"]/g, (c) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', \"'\": '&#39;', '\"': '&quot;' }[c]));\n}\n";
const CSS_CONTENT = ":root { color-scheme: dark; }\nbody { background: #0f172a; }\n\n.btn-primary {\n  border-radius: 0.75rem;\n  background: #06b6d4;\n  color: #0f172a;\n  font-weight: 600;\n  padding: 0.5rem 1rem;\n  transition: 0.2s ease;\n}\n.btn-primary:hover { background: #22d3ee; }\n\n.btn-secondary {\n  border-radius: 0.75rem;\n  border: 1px solid #475569;\n  background: rgba(30, 41, 59, 0.7);\n  color: #e2e8f0;\n  padding: 0.5rem 1rem;\n  transition: 0.2s ease;\n}\n.btn-secondary:hover { border-color: #94a3b8; }\n\n.input {\n  border-radius: 0.75rem;\n  border: 1px solid #475569;\n  background: rgba(15, 23, 42, 0.8);\n  color: #f1f5f9;\n  padding: 0.5rem 0.75rem;\n}\n.input:focus {\n  outline: none;\n  border-color: #22d3ee;\n  box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.2);\n}\n\n.card {\n  border-radius: 1rem;\n  border: 1px solid #334155;\n  background: rgba(15, 23, 42, 0.45);\n  padding: 0.75rem;\n}\n\n.chip {\n  border-radius: 0.75rem;\n  border: 1px solid #334155;\n  background: rgba(15, 23, 42, 0.45);\n  padding: 0.5rem 0.75rem;\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 0.5rem;\n}\n\n.modal { background: transparent; border: none; padding: 0; }\n.modal::backdrop { background: rgba(2, 6, 23, 0.75); }\n\n.swatch {\n  width: 18px;\n  height: 18px;\n  border-radius: 999px;\n  border: 1px solid rgba(255,255,255,0.35);\n}\n\n.low-stock {\n  border-color: #f59e0b !important;\n  box-shadow: 0 0 0 1px rgba(245, 158, 11, 0.4) inset;\n}\n";

function json(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: { 'Content-Type': 'application/json;charset=UTF-8' },
  });
}

async function readBody(request) {
  try { return await request.json(); }
  catch { return null; }
}

function toSpoolRow(input) {
  return {
    id: String(input.id || crypto.randomUUID()),
    brand: String(input.brand || '').trim(),
    color_name: String(input.colorName || input.color_name || '').trim(),
    color_hex: String(input.colorHex || input.color_hex || '#ffffff').trim() || '#ffffff',
    material: String(input.material || 'PLA').trim() || 'PLA',
    diameter: Number(input.diameter) || 1.75,
    total_weight: Number(input.totalWeight ?? input.total_weight),
    remaining_weight: Number(input.remainingWeight ?? input.remaining_weight),
    location: String(input.location || '').trim(),
    purchase_date: String(input.purchaseDate || input.purchase_date || '').trim(),
    cost: Number(input.cost) || 0,
    notes: String(input.notes || '').trim(),
  };
}

function spoolToApi(row) {
  return {
    id: row.id,
    brand: row.brand,
    colorName: row.color_name,
    colorHex: row.color_hex,
    material: row.material,
    diameter: Number(row.diameter),
    totalWeight: Number(row.total_weight),
    remainingWeight: Number(row.remaining_weight),
    location: row.location || '',
    purchaseDate: row.purchase_date || '',
    cost: Number(row.cost || 0),
    notes: row.notes || '',
    createdAt: row.created_at,
    updatedAt: row.updated_at,
  };
}

async function handleApi(request, env, url) {
  const { pathname } = url;
  const method = request.method.toUpperCase();

  if (pathname === '/api/spools' && method === 'GET') {
    const rows = await env.DB.prepare('SELECT * FROM spools ORDER BY datetime(created_at) DESC').all();
    return json((rows.results || []).map(spoolToApi));
  }

  if (pathname === '/api/spools' && method === 'POST') {
    const body = await readBody(request);
    if (!body) return json({ error: 'Invalid JSON body' }, 400);

    const spool = toSpoolRow(body);
    if (!spool.brand || !spool.color_name || Number.isNaN(spool.total_weight) || Number.isNaN(spool.remaining_weight)) {
      return json({ error: 'Missing required spool fields' }, 400);
    }
    if (spool.remaining_weight > spool.total_weight) {
      return json({ error: 'Remaining weight cannot be greater than total weight' }, 400);
    }

    await env.DB.prepare(
      'INSERT INTO spools (id, brand, color_name, color_hex, material, diameter, total_weight, remaining_weight, location, purchase_date, cost, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'
    ).bind(
      spool.id, spool.brand, spool.color_name, spool.color_hex, spool.material, spool.diameter,
      spool.total_weight, spool.remaining_weight, spool.location, spool.purchase_date, spool.cost, spool.notes
    ).run();

    return json({ ok: true, id: spool.id }, 201);
  }

  const spoolMatch = pathname.match(new RegExp('^/api/spools/([^/]+)$'));
  if (spoolMatch && method === 'PUT') {
    const id = decodeURIComponent(spoolMatch[1]);
    const body = await readBody(request);
    if (!body) return json({ error: 'Invalid JSON body' }, 400);

    const spool = toSpoolRow({ ...body, id });
    if (!spool.brand || !spool.color_name || Number.isNaN(spool.total_weight) || Number.isNaN(spool.remaining_weight)) {
      return json({ error: 'Missing required spool fields' }, 400);
    }
    if (spool.remaining_weight > spool.total_weight) {
      return json({ error: 'Remaining weight cannot be greater than total weight' }, 400);
    }

    const result = await env.DB.prepare(
      "UPDATE spools SET brand=?, color_name=?, color_hex=?, material=?, diameter=?, total_weight=?, remaining_weight=?, location=?, purchase_date=?, cost=?, notes=?, updated_at=datetime('now') WHERE id=?"
    ).bind(
      spool.brand, spool.color_name, spool.color_hex, spool.material, spool.diameter,
      spool.total_weight, spool.remaining_weight, spool.location, spool.purchase_date, spool.cost, spool.notes, id
    ).run();

    if (!result.success) return json({ error: 'Failed to update spool' }, 500);
    return json({ ok: true });
  }

  if (spoolMatch && method === 'DELETE') {
    const id = decodeURIComponent(spoolMatch[1]);
    await env.DB.prepare('DELETE FROM spools WHERE id = ?').bind(id).run();
    return json({ ok: true });
  }

  if (pathname === '/api/ams-mapping' && method === 'GET') {
    const rows = await env.DB.prepare('SELECT slot, spool_id FROM ams_spool_mapping ORDER BY slot ASC').all();
    return json((rows.results || []).map((r) => ({
      slot: Number(r.slot),
      spoolId: String(r.spool_id || ''),
    })));
  }

  const amsMappingMatch = pathname.match(new RegExp('^/api/ams-mapping/(\\d+)$'));
  if (amsMappingMatch && method === 'PUT') {
    const slot = Number(amsMappingMatch[1]);
    const body = await readBody(request);
    if (!body || typeof body.spoolId !== 'string') return json({ error: 'spoolId is required' }, 400);

    await env.DB.prepare(
      "INSERT INTO ams_spool_mapping (slot, spool_id, updated_at) VALUES (?, ?, datetime('now')) ON CONFLICT(slot) DO UPDATE SET spool_id=excluded.spool_id, updated_at=datetime('now')"
    ).bind(slot, body.spoolId.trim()).run();

    return json({ ok: true });
  }

  if (amsMappingMatch && method === 'DELETE') {
    const slot = Number(amsMappingMatch[1]);
    await env.DB.prepare(
      "INSERT INTO ams_spool_mapping (slot, spool_id, updated_at) VALUES (?, '', datetime('now')) ON CONFLICT(slot) DO UPDATE SET spool_id='', updated_at=datetime('now')"
    ).bind(slot).run();
    return json({ ok: true });
  }

  if (pathname === '/api/locations' && method === 'GET') {
    const rows = await env.DB.prepare('SELECT * FROM storage_locations ORDER BY name COLLATE NOCASE ASC').all();
    return json((rows.results || []).map((r) => ({ id: r.id, name: r.name, createdAt: r.created_at })));
  }

  if (pathname === '/api/locations' && method === 'POST') {
    const body = await readBody(request);
    const name = String(body?.name || '').trim();
    if (!name) return json({ error: 'Location name is required' }, 400);
    const id = crypto.randomUUID();

    try {
      await env.DB.prepare('INSERT INTO storage_locations (id, name) VALUES (?, ?)').bind(id, name).run();
      return json({ id, name }, 201);
    } catch (err) {
      return json({ error: 'Location already exists' }, 409);
    }
  }

  const locMatch = pathname.match(new RegExp('^/api/locations/([^/]+)$'));
  if (locMatch && method === 'DELETE') {
    const id = decodeURIComponent(locMatch[1]);
    await env.DB.prepare('DELETE FROM storage_locations WHERE id = ?').bind(id).run();
    return json({ ok: true });
  }

  if (pathname === '/api/printer' && method === 'GET') {
    const row = await env.DB.prepare("SELECT ip, token, serial FROM printer_config WHERE id = 'default' LIMIT 1").first();
    return json({ ip: row?.ip || '', token: row?.token || '', serial: row?.serial || '' });
  }

  if (pathname === '/api/printer' && method === 'PUT') {
    const body = await readBody(request);
    if (!body) return json({ error: 'Invalid JSON body' }, 400);
    const ip = String(body.ip || '').trim();
    const token = String(body.token || '').trim();
    const serial = String(body.serial || '').trim();

    await env.DB.prepare(
      "INSERT INTO printer_config (id, ip, token, serial, updated_at) VALUES ('default', ?, ?, ?, datetime('now')) ON CONFLICT(id) DO UPDATE SET ip=excluded.ip, token=excluded.token, serial=excluded.serial, updated_at=datetime('now')"
    ).bind(ip, token, serial).run();

    return json({ ok: true });
  }

  if (pathname === '/api/printer-status' && method === 'GET') {
    const row = await env.DB.prepare("SELECT * FROM printer_status WHERE id = 'default' LIMIT 1").first();
    if (!row) {
      return json({
        id: 'default',
        state: 'offline',
        nozzleTemp: 0,
        nozzleTarget: 0,
        bedTemp: 0,
        bedTarget: 0,
        chamberTemp: 0,
        progress: 0,
        remainingMinutes: 0,
        currentFile: '',
        currentLayer: 0,
        totalLayers: 0,
        fanSpeed: 0,
        errors: [],
        ams: {},
        updatedAt: null,
      });
    }

    return json({
      id: row.id,
      state: row.state || 'offline',
      nozzleTemp: Number(row.nozzle_temp || 0),
      nozzleTarget: Number(row.nozzle_target || 0),
      bedTemp: Number(row.bed_temp || 0),
      bedTarget: Number(row.bed_target || 0),
      chamberTemp: Number(row.chamber_temp || 0),
      progress: Number(row.progress || 0),
      remainingMinutes: Number(row.remaining_minutes || 0),
      currentFile: row.current_file || '',
      currentLayer: Number(row.current_layer || 0),
      totalLayers: Number(row.total_layers || 0),
      fanSpeed: Number(row.fan_speed || 0),
      errors: (() => {
        try { return JSON.parse(row.errors || '[]'); }
        catch { return []; }
      })(),
      ams: (() => {
        try { return JSON.parse(row.ams_data || '{}'); }
        catch { return {}; }
      })(),
      updatedAt: row.updated_at || null,
    });
  }

  if (pathname === '/api/printer-status' && method === 'PUT') {
    const body = await readBody(request);
    if (!body) return json({ error: 'Invalid JSON body' }, 400);

    const toNum = (v, d = 0) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : d;
    };

    await env.DB.prepare(
      "INSERT INTO printer_status (id, state, nozzle_temp, nozzle_target, bed_temp, bed_target, chamber_temp, progress, remaining_minutes, current_file, current_layer, total_layers, fan_speed, errors, ams_data, updated_at) VALUES ('default', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now')) ON CONFLICT(id) DO UPDATE SET state=excluded.state, nozzle_temp=excluded.nozzle_temp, nozzle_target=excluded.nozzle_target, bed_temp=excluded.bed_temp, bed_target=excluded.bed_target, chamber_temp=excluded.chamber_temp, progress=excluded.progress, remaining_minutes=excluded.remaining_minutes, current_file=excluded.current_file, current_layer=excluded.current_layer, total_layers=excluded.total_layers, fan_speed=excluded.fan_speed, errors=excluded.errors, ams_data=excluded.ams_data, updated_at=datetime('now')"
    ).bind(
      String(body.state || 'offline').toLowerCase(),
      toNum(body.nozzleTemp ?? body.nozzle_temp),
      toNum(body.nozzleTarget ?? body.nozzle_target),
      toNum(body.bedTemp ?? body.bed_temp),
      toNum(body.bedTarget ?? body.bed_target),
      toNum(body.chamberTemp ?? body.chamber_temp),
      Math.round(toNum(body.progress)),
      Math.round(toNum(body.remainingMinutes ?? body.remaining_minutes)),
      String(body.currentFile ?? body.current_file ?? ''),
      Math.round(toNum(body.currentLayer ?? body.current_layer)),
      Math.round(toNum(body.totalLayers ?? body.total_layers)),
      Math.round(toNum(body.fanSpeed ?? body.fan_speed)),
      JSON.stringify(Array.isArray(body.errors) ? body.errors : []),
      JSON.stringify(body.ams || {})
    ).run();

    return json({ ok: true });
  }

  if (pathname === '/api/export' && method === 'GET') {
    const [spools, locations, printer] = await Promise.all([
      env.DB.prepare('SELECT * FROM spools ORDER BY datetime(created_at) DESC').all(),
      env.DB.prepare('SELECT * FROM storage_locations ORDER BY name COLLATE NOCASE ASC').all(),
      env.DB.prepare("SELECT ip, token FROM printer_config WHERE id='default' LIMIT 1").first(),
    ]);

    return json({
      exportedAt: new Date().toISOString(),
      spools: (spools.results || []).map(spoolToApi),
      locations: (locations.results || []).map((r) => ({ id: r.id, name: r.name })),
      printer: { ip: printer?.ip || '', token: printer?.token || '' },
    });
  }

  if (pathname === '/api/import' && method === 'POST') {
    const body = await readBody(request);
    const incoming = Array.isArray(body) ? body : body?.spools;
    if (!Array.isArray(incoming)) return json({ error: 'Invalid import format' }, 400);

    await env.DB.prepare('DELETE FROM spools').run();

    for (const raw of incoming) {
      const spool = toSpoolRow(raw);
      if (!spool.brand || !spool.color_name || Number.isNaN(spool.total_weight) || Number.isNaN(spool.remaining_weight)) continue;
      await env.DB.prepare(
        'INSERT INTO spools (id, brand, color_name, color_hex, material, diameter, total_weight, remaining_weight, location, purchase_date, cost, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)'
      ).bind(
        spool.id, spool.brand, spool.color_name, spool.color_hex, spool.material, spool.diameter,
        spool.total_weight, spool.remaining_weight, spool.location, spool.purchase_date, spool.cost, spool.notes
      ).run();
    }

    return json({ ok: true });
  }

  return null;
}

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    if (url.pathname.startsWith('/api/')) {
      const apiResponse = await handleApi(request, env, url);
      if (apiResponse) return apiResponse;
      return json({ error: 'Not found' }, 404);
    }

    if (url.pathname === '/' || url.pathname === '/index.html') {
      return new Response(HTML_CONTENT, { headers: { 'Content-Type': 'text/html;charset=UTF-8' } });
    }
    if (url.pathname === '/app.js') {
      return new Response(JS_CONTENT, { headers: { 'Content-Type': 'application/javascript;charset=UTF-8' } });
    }
    if (url.pathname === '/styles.css') {
      return new Response(CSS_CONTENT, { headers: { 'Content-Type': 'text/css;charset=UTF-8' } });
    }

    return new Response('Not Found', { status: 404 });
  },
};
